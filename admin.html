<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Olive Elements - Camping Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/admin.css" rel="stylesheet" />
  <style>
    /* Fullscreen login overlay */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 100vw;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #loginBox {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      max-width: 350px;
      width: 100%;
    }

    body.locked main,
    body.locked aside {
      filter: blur(5px);
      pointer-events: none;
      user-select: none;
    }

    .status-done {
      color: green;
      font-weight: bold;
    }

    .status-pending {
      color: orange;
      font-weight: bold;
    }

    .status-failed {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body class="locked">

  <!-- Login Overlay -->
  <div id="loginOverlay">
    <div id="loginBox" class="text-center">
      <h4 class="mb-3">Admin Login</h4>
      <div class="mb-3 text-start">
        <label class="form-label">Username</label>
        <input type="text" id="username" class="form-control" placeholder="Enter username">
      </div>
      <div class="mb-3 text-start">
        <label class="form-label">Password</label>
        <input type="password" id="password" class="form-control" placeholder="Enter password">
      </div>
      <button class="btn btn-primary w-100" onclick="checkLogin()">Login</button>
      <p id="errorMsg" class="text-danger mt-2 small"></p>
    </div>
  </div>

  <div class="d-flex">

    <!-- Sidebar -->
    <aside class="sidebar p-4 d-flex flex-column bg-dark text-light">
      <div class="d-flex align-items-center mb-4">
        <img src="img/logo.png" class="me-2" width="40" alt="Logo">
        <h5 class="m-0">Olive Elements</h5>
      </div>
      <nav class="nav flex-column mb-4">
        <a class="nav-link text-light" href="admin.html">Dashboard</a>
        <a class="nav-link text-light" href="events_admin.html">Campsites</a>
        <a class="nav-link text-light" href="admin_ads.html">Advertisement</a>
        <a class="nav-link text-light" href="blog_admin.html">Blogs</a>
        <a class="nav-link text-light" href="admin_applications.html">Careers</a>
      </nav>
      <div class="pt-4">
        <a href="javascript:void(0)" onclick="logout()" class="d-block text-warning">Log Out</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow-1 p-4">
      <div class="hero mb-4">
        <div class="hero-content">
          <h2>Welcome to Olive Elements Admin Panel</h2>
        </div>
      </div>

      <h5 class="fw-bold mb-3">Transactions</h5>
      <div class="card card-custom p-3">
        <table class="table align-middle" id="transactionsTable">
          <thead>
            <tr class="text-muted small">
              <th>Booking</th>
              <th>Type</th>
              <th>Status</th>
              <th>Date</th>
              <th>Amount</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="transactionsBody">
            <!-- Loaded from localStorage -->
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Product:</strong> <span id="modalProduct"></span></p>
          <p><strong>Name:</strong> <span id="modalName"></span></p>
          <p><strong>Email:</strong> <span id="modalEmail"></span></p>
          <p><strong>Phone:</strong> <span id="modalPhone"></span></p>
          <p><strong>Check-in:</strong> <span id="modalCheckIn"></span></p>
          <p><strong>Check-out:</strong> <span id="modalCheckOut"></span></p>
          <p><strong>Guests:</strong> <span id="modalGuests"></span></p>
          <p><strong>Amount Paid:</strong> <span id="modalAmount"></span></p>
          <p><strong>Status:</strong> <span id="modalStatus"></span></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" onclick="generateInvoice()">Generate Invoice</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Hardcoded credentials
    const validUser = "admin";
    const validPass = "olive123";

    function checkLogin() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;

      if (user === validUser && pass === validPass) {
        document.getElementById("loginOverlay").style.display = "none";
        document.body.classList.remove("locked");
      } else {
        document.getElementById("errorMsg").innerText = "Invalid username or password";
      }
    }

    function logout() {
      document.getElementById("loginOverlay").style.display = "flex";
      document.body.classList.add("locked");
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      document.getElementById("errorMsg").innerText = "";
    }

    // ✅ Load payments from localStorage
    function loadPayments() {
      const tbody = document.getElementById("transactionsBody");
      tbody.innerHTML = "";
      let payments = JSON.parse(localStorage.getItem("payments")) || [];

      payments.forEach((p, index) => {
        let row = `<tr>
          <td>${p.booking}</td>
          <td>${p.type}</td>
          <td><span class="status-${p.status.toLowerCase()}">${p.status}</span></td>
          <td>${p.date}</td>
          <td>₹${p.amount}</td>
          <td>
            <button class="btn btn-sm btn-primary me-2" onclick='viewBooking(${JSON.stringify(p)})'>View</button>
            <button class="btn btn-sm btn-danger" onclick="deletePayment(${index})">Delete</button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function viewBooking(data) {
      document.getElementById("modalProduct").innerText = data.booking || "-";
      document.getElementById("modalName").innerText = data.name || "-";
      document.getElementById("modalEmail").innerText = data.email || "-";
      document.getElementById("modalPhone").innerText = data.phone || "-";
      document.getElementById("modalCheckIn").innerText = data.checkIn || "-";
      document.getElementById("modalCheckOut").innerText = data.checkOut || "-";
      document.getElementById("modalGuests").innerText = data.guests || "-";
      document.getElementById("modalAmount").innerText = "₹" + (data.amount || "0");
      document.getElementById("modalStatus").innerText = data.status;

      const modal = new bootstrap.Modal(document.getElementById("bookingModal"));
      modal.show();
    }

    function deletePayment(index) {
      if (confirm("Are you sure you want to delete this booking?")) {
        let payments = JSON.parse(localStorage.getItem("payments")) || [];
        payments.splice(index, 1);
        localStorage.setItem("payments", JSON.stringify(payments));
        loadPayments();
      }
    }

    // ✅ Generate Invoice + send to backend
    async function generateInvoice() {
      const email = document.getElementById("modalEmail").innerText;
      const booking = {
        booking: document.getElementById("modalProduct").innerText,
        name: document.getElementById("modalName").innerText,
        phone: document.getElementById("modalPhone").innerText,
        checkIn: document.getElementById("modalCheckIn").innerText,
        checkOut: document.getElementById("modalCheckOut").innerText,
        guests: document.getElementById("modalGuests").innerText,
        amount: document.getElementById("modalAmount").innerText.replace("₹", "").trim(),
        status: document.getElementById("modalStatus").innerText,
      };

      try {
        const res = await fetch("http://localhost:3000/send-invoice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, booking }),
        });

        const result = await res.json();
        if (result.success) {
          alert("✅ Invoice sent successfully!");
        } else {
          console.error("Backend error:", result);
          alert("❌ Failed to send invoice.");
        }
      } catch (err) {
        console.error("Fetch error:", err);
        alert("⚠️ Error sending invoice.");
      }
    }

    window.onload = function () {
      logout();
      loadPayments();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
